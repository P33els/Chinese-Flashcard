<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Grammar Quiz - ËØ≠Ê≥ïÁªÉ‰π†</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Noto+Sans+Thai:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* Grammar Page Specific Styles */
        .grammar-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 25px;
            border: 2px solid rgba(212, 175, 55, 0.3);
            background: transparent;
            color: #d4af37;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            margin-bottom: 20px;
        }

        .back-btn:hover {
            background: rgba(212, 175, 55, 0.1);
            border-color: #d4af37;
        }

        .grammar-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .grammar-header h1 {
            font-size: 2rem;
            color: #e8c170;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            margin-bottom: 10px;
        }

        .grammar-header p {
            color: #a0a0a0;
        }

        /* Mode Selection */
        .mode-selection {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 14px 28px;
            border-radius: 12px;
            border: 2px solid rgba(212, 175, 55, 0.3);
            background: transparent;
            color: #d4af37;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-btn:hover {
            background: rgba(212, 175, 55, 0.1);
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #d4af37, #b8962e);
            color: #1a1a1a;
            border-color: #d4af37;
        }

        /* Stats Bar */
        .grammar-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .grammar-stat {
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .grammar-stat.correct {
            background: rgba(46, 213, 115, 0.2);
            border: 2px solid #2ed573;
            color: #2ed573;
        }

        .grammar-stat.wrong {
            background: rgba(255, 71, 87, 0.2);
            border: 2px solid #ff4757;
            color: #ff4757;
        }

        .grammar-stat.total {
            background: rgba(232, 193, 112, 0.2);
            border: 2px solid #e8c170;
            color: #e8c170;
        }

        /* Progress */
        .grammar-progress {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 8px;
            margin-bottom: 30px;
            overflow: hidden;
        }

        .grammar-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #d4af37, #e8c170);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        /* Study Mode - Grammar Card */
        .grammar-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.05), rgba(0, 0, 0, 0.2));
            border-radius: 20px;
            padding: 30px;
            border: 2px solid rgba(212, 175, 55, 0.2);
            margin-bottom: 24px;
        }

        .grammar-hanzi {
            font-size: 3rem;
            color: #e8c170;
            font-family: 'Noto Serif SC', serif;
            text-align: center;
            margin-bottom: 10px;
        }

        .grammar-pinyin {
            text-align: center;
            color: #88c0d0;
            font-size: 1.3rem;
            margin-bottom: 16px;
        }

        .grammar-type {
            text-align: center;
            margin-bottom: 20px;
        }

        .grammar-type span {
            background: rgba(212, 175, 55, 0.2);
            color: #d4af37;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .grammar-section {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .grammar-section h3 {
            color: #d4af37;
            font-size: 0.95rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .grammar-meaning {
            color: #f5f0e6;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .grammar-meaning span {
            display: inline-block;
            background: rgba(136, 192, 208, 0.2);
            padding: 2px 8px;
            border-radius: 4px;
            margin: 2px;
        }

        .grammar-usage {
            color: #c0b090;
            font-size: 1rem;
            line-height: 1.6;
        }

        .grammar-pattern {
            font-family: 'Noto Serif SC', serif;
            font-size: 1.1rem;
            color: #88c0d0;
            background: rgba(136, 192, 208, 0.1);
            padding: 12px 16px;
            border-radius: 8px;
            border-left: 3px solid #88c0d0;
        }

        .grammar-examples {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .example-item {
            background: rgba(212, 175, 55, 0.05);
            padding: 16px;
            border-radius: 10px;
            border-left: 3px solid #d4af37;
        }

        .example-zh {
            font-family: 'Noto Serif SC', serif;
            font-size: 1.2rem;
            color: #f5f0e6;
            margin-bottom: 8px;
        }

        .example-th {
            color: #a0a0a0;
            font-size: 0.95rem;
        }

        /* Quiz Mode */
        .quiz-question {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.05), rgba(0, 0, 0, 0.2));
            border-radius: 20px;
            padding: 30px;
            border: 2px solid rgba(212, 175, 55, 0.2);
            margin-bottom: 24px;
            text-align: center;
        }

        .quiz-prompt {
            color: #a0a0a0;
            font-size: 1rem;
            margin-bottom: 16px;
        }

        .quiz-sentence {
            font-family: 'Noto Serif SC', serif;
            font-size: 1.5rem;
            color: #f5f0e6;
            line-height: 1.8;
            margin-bottom: 8px;
        }

        .quiz-sentence .blank {
            display: inline-block;
            min-width: 80px;
            border-bottom: 3px solid #d4af37;
            margin: 0 4px;
            color: #d4af37;
        }

        .quiz-type-label {
            font-family: 'Noto Sans Thai', sans-serif;
            font-size: 1rem;
            color: #88c0d0;
            margin-bottom: 12px;
            font-weight: 600;
        }

        .quiz-word-highlight {
            font-size: 2.5rem;
            color: #e8c170;
            font-family: 'Noto Serif SC', serif;
        }

        .quiz-pinyin {
            color: #88c0d0;
            font-size: 1.1rem;
        }

        .quiz-translation {
            color: #888;
            font-size: 1rem;
        }

        .quiz-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        @media (max-width: 600px) {
            .quiz-options {
                grid-template-columns: 1fr;
            }
        }

        .quiz-option {
            padding: 20px;
            border-radius: 12px;
            border: 2px solid rgba(212, 175, 55, 0.3);
            background: rgba(0, 0, 0, 0.2);
            color: #f5f0e6;
            font-size: 1.2rem;
            font-family: 'Noto Serif SC', serif;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quiz-option-sentence {
            font-size: 1rem;
            text-align: left;
            line-height: 1.6;
        }

        .quiz-option:hover:not(.disabled) {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.1);
            transform: translateY(-2px);
        }

        .quiz-option.correct {
            border-color: #2ed573;
            background: rgba(46, 213, 115, 0.2);
            color: #2ed573;
        }

        .quiz-option.wrong {
            border-color: #ff4757;
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
        }

        .quiz-option.disabled {
            pointer-events: none;
            opacity: 0.7;
        }

        .quiz-feedback {
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
        }

        .quiz-feedback.show {
            display: block;
        }

        .quiz-feedback.correct {
            background: rgba(46, 213, 115, 0.1);
            border: 2px solid #2ed573;
        }

        .quiz-feedback.wrong {
            background: rgba(255, 71, 87, 0.1);
            border: 2px solid #ff4757;
        }

        .quiz-feedback h4 {
            font-size: 1.1rem;
            margin-bottom: 12px;
        }

        .quiz-feedback.correct h4 {
            color: #2ed573;
        }

        .quiz-feedback.wrong h4 {
            color: #ff4757;
        }

        .quiz-feedback p {
            color: #c0b090;
            line-height: 1.6;
        }

        /* Navigation Buttons */
        .grammar-nav {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 30px;
        }

        .nav-btn {
            padding: 14px 28px;
            border-radius: 12px;
            border: 2px solid rgba(212, 175, 55, 0.3);
            background: transparent;
            color: #d4af37;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            background: rgba(212, 175, 55, 0.1);
            border-color: #d4af37;
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nav-btn.primary {
            background: linear-gradient(135deg, #d4af37, #b8962e);
            color: #1a1a1a;
            border-color: #d4af37;
        }

        .nav-btn.primary:hover {
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.4);
        }

        /* Topic List */
        .topic-list {
            display: none;
        }

        .topic-list.active {
            display: block;
        }

        .topic-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .topic-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid rgba(212, 175, 55, 0.2);
            cursor: pointer;
            transition: all 0.3s;
        }

        .topic-item:hover {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.05);
            transform: translateY(-2px);
        }

        .topic-item.completed {
            border-color: #2ed573;
        }

        .topic-hanzi {
            font-family: 'Noto Serif SC', serif;
            font-size: 1.5rem;
            color: #e8c170;
            margin-bottom: 4px;
        }

        .topic-pinyin {
            color: #88c0d0;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .topic-meaning {
            color: #a0a0a0;
            font-size: 0.9rem;
        }

        .topic-status {
            margin-top: 10px;
            font-size: 0.8rem;
        }

        .topic-status.completed {
            color: #2ed573;
        }

        /* Content Sections */
        .study-content, .quiz-content {
            display: none;
        }

        .study-content.active, .quiz-content.active {
            display: block;
        }

        /* Sound Button */
        .sound-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s;
        }

        .sound-btn:hover {
            background: rgba(212, 175, 55, 0.2);
        }

        /* Footer */
        .grammar-footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(212, 175, 55, 0.2);
            color: #666;
        }

        .grammar-footer strong {
            color: #d4af37;
        }

        /* Quiz Complete */
        .quiz-complete {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .quiz-complete.active {
            display: block;
        }

        .quiz-complete h2 {
            font-size: 2rem;
            color: #e8c170;
            margin-bottom: 20px;
        }

        .quiz-complete-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 30px;
        }

        .complete-stat {
            text-align: center;
        }

        .complete-stat-value {
            font-size: 2.5rem;
            font-weight: bold;
        }

        .complete-stat-value.correct {
            color: #2ed573;
        }

        .complete-stat-value.wrong {
            color: #ff4757;
        }

        .complete-stat-label {
            color: #888;
            font-size: 0.9rem;
        }

        .quiz-complete p {
            color: #a0a0a0;
            margin-bottom: 30px;
        }

        /* Search Box for List Mode */
        .list-search-container {
            margin-bottom: 20px;
        }

        .list-search-input {
            width: 100%;
            padding: 14px 20px;
            border-radius: 12px;
            border: 2px solid rgba(212, 175, 55, 0.3);
            background: rgba(0, 0, 0, 0.3);
            color: #f5f0e6;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s;
        }

        .list-search-input:focus {
            border-color: #d4af37;
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.2);
        }

        .list-search-input::placeholder {
            color: #888;
        }

        .search-results-count {
            text-align: center;
            color: #888;
            margin-bottom: 16px;
            font-size: 0.9rem;
        }

        /* Drag Game Styles */
        .drag-content {
            display: none;
        }

        .drag-content.active {
            display: block;
        }

        .drag-game-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.05), rgba(0, 0, 0, 0.2));
            border-radius: 20px;
            padding: 30px;
            border: 2px solid rgba(212, 175, 55, 0.2);
            margin-bottom: 24px;
        }

        .drag-instruction {
            text-align: center;
            color: #a0a0a0;
            margin-bottom: 20px;
        }

        .drag-translation {
            text-align: center;
            font-size: 1.2rem;
            color: #88c0d0;
            margin-bottom: 24px;
            padding: 16px;
            background: rgba(136, 192, 208, 0.1);
            border-radius: 12px;
        }

        .drag-drop-zone {
            min-height: 80px;
            border: 3px dashed rgba(212, 175, 55, 0.4);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            align-items: center;
            transition: all 0.3s;
            background: rgba(0, 0, 0, 0.2);
        }

        .drag-drop-zone.drag-over {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.1);
        }

        .drag-drop-zone.correct {
            border-color: #2ed573;
            background: rgba(46, 213, 115, 0.1);
        }

        .drag-drop-zone.wrong {
            border-color: #ff4757;
            background: rgba(255, 71, 87, 0.1);
        }

        .drag-word-bank {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            margin-bottom: 24px;
        }

        .drag-word {
            padding: 12px 20px;
            background: linear-gradient(135deg, rgba(212, 175, 55, 0.2), rgba(212, 175, 55, 0.1));
            border: 2px solid rgba(212, 175, 55, 0.4);
            border-radius: 10px;
            cursor: grab;
            font-family: 'Noto Serif SC', serif;
            font-size: 1.3rem;
            color: #e8c170;
            transition: all 0.3s;
            user-select: none;
        }

        .drag-word:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
            border-color: #d4af37;
        }

        .drag-word.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .drag-word.placed {
            background: linear-gradient(135deg, rgba(136, 192, 208, 0.2), rgba(136, 192, 208, 0.1));
            border-color: #88c0d0;
            color: #88c0d0;
        }

        .drag-word.in-zone {
            cursor: grab;
        }

        .drop-placeholder {
            color: #666;
            font-style: italic;
        }

        /* Match Mode Styles */
        .match-word {
            text-align: center;
            margin-bottom: 30px;
        }

        .match-hanzi {
            display: block;
            font-family: 'Noto Serif SC', serif;
            font-size: 3rem;
            color: #e8c170;
            margin-bottom: 8px;
        }

        .match-pinyin {
            color: #88c0d0;
            font-size: 1.3rem;
        }

        .match-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        @media (max-width: 600px) {
            .match-options {
                grid-template-columns: 1fr;
            }
        }

        .match-option {
            padding: 18px 20px;
            border-radius: 12px;
            border: 2px solid rgba(136, 192, 208, 0.3);
            background: rgba(0, 0, 0, 0.2);
            color: #f5f0e6;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .match-option:hover:not(.disabled) {
            border-color: #88c0d0;
            background: rgba(136, 192, 208, 0.1);
            transform: translateY(-2px);
        }

        .match-option.correct {
            border-color: #2ed573;
            background: rgba(46, 213, 115, 0.2);
            color: #2ed573;
        }

        .match-option.wrong {
            border-color: #ff4757;
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
        }

        .match-option.disabled {
            pointer-events: none;
            opacity: 0.7;
        }

        .drag-actions {
            display: flex;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .drag-feedback {
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
        }

        .drag-feedback.show {
            display: block;
        }

        .drag-feedback.correct {
            background: rgba(46, 213, 115, 0.1);
            border: 2px solid #2ed573;
        }

        .drag-feedback.correct h4 {
            color: #2ed573;
        }

        .drag-feedback.wrong {
            background: rgba(255, 71, 87, 0.1);
            border: 2px solid #ff4757;
        }

        .drag-feedback.wrong h4 {
            color: #ff4757;
        }

        .drag-feedback h4 {
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .drag-feedback p {
            color: #c0b090;
        }

        .drag-correct-answer {
            font-family: 'Noto Serif SC', serif;
            font-size: 1.3rem;
            color: #2ed573;
            margin-top: 10px;
        }

        .drag-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 600px) {
            .drag-word {
                padding: 10px 16px;
                font-size: 1.1rem;
            }
        }

        /* Drag Ghost for Touch */
        .drag-ghost {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            padding: 12px 20px;
            background: linear-gradient(135deg, #d4af37, #b8962e);
            border: 2px solid #d4af37;
            border-radius: 10px;
            font-family: 'Noto Serif SC', serif;
            font-size: 1.3rem;
            color: #1a1a1a;
            box-shadow: 0 8px 25px rgba(212, 175, 55, 0.5);
            transform: translate(-50%, -50%) scale(1.1);
            transition: transform 0.1s ease;
        }

        @media (max-width: 600px) {
            .drag-ghost {
                padding: 10px 16px;
                font-size: 1.1rem;
            }
        }

        .drag-word.touch-active {
            opacity: 0.4;
            transform: scale(0.95);
        }
    </style>    
</head>
<body>
    <div class="grammar-container">
        <!-- Back Button -->
        <a href="index.html" class="back-btn">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>

        <!-- Header -->
        <header class="grammar-header">
            <h1>üìù Grammar Quiz ËØ≠Ê≥ïÁªÉ‰π†</h1>
            <p>‡∏ù‡∏∂‡∏Å‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏à‡∏µ‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡πÅ‡∏•‡∏∞‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</p>
        </header>

        <!-- Mode Selection -->
        <div class="mode-selection">
            <button class="mode-btn active" id="studyModeBtn">üìñ ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ</button>
            <button class="mode-btn" id="quizModeBtn">‚úèÔ∏è ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö</button>
            <button class="mode-btn" id="dragModeBtn">üß© ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ</button>
            <button class="mode-btn" id="listModeBtn">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        </div>

        <!-- Stats -->
        <div class="grammar-stats" id="quizStats" style="display: none;">
            <span class="grammar-stat correct">‚úì ‡∏ñ‡∏π‡∏Å: <span id="correctCount">0</span></span>
            <span class="grammar-stat wrong">‚úó ‡∏ú‡∏¥‡∏î: <span id="wrongCount">0</span></span>
            <span class="grammar-stat total">üìö ‡∏Ç‡πâ‡∏≠: <span id="questionNum">1</span>/<span id="totalQuestions">10</span></span>
        </div>

        <!-- Progress -->
        <div class="grammar-progress" id="progressBar" style="display: none;">
            <div class="grammar-progress-bar" id="progressFill" style="width: 0%"></div>
        </div>

        <!-- Study Mode Content -->
        <div class="study-content active" id="studyContent">
            <div class="grammar-card" id="grammarCard">
                <div class="grammar-hanzi" id="studyHanzi">Âç¥</div>
                <button class="sound-btn" id="studySoundBtn">üîä</button>
                <div class="grammar-pinyin" id="studyPinyin">qu√®</div>
                <div class="grammar-type"><span id="studyType">‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°</span></div>

                <div class="grammar-section">
                    <h3>üìö ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢</h3>
                    <div class="grammar-meaning" id="studyMeaning"></div>
                </div>

                <div class="grammar-section">
                    <h3>üìù ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ</h3>
                    <div class="grammar-usage" id="studyUsage"></div>
                </div>

                <div class="grammar-section">
                    <h3>üî§ ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á</h3>
                    <div class="grammar-pattern" id="studyPattern"></div>
                </div>

                <div class="grammar-section">
                    <h3>üí¨ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ</h3>
                    <div class="grammar-examples" id="studyExamples"></div>
                </div>
            </div>

            <div class="grammar-nav">
                <button class="nav-btn" id="studyPrevBtn">‚¨ÖÔ∏è ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
                <button class="nav-btn primary" id="studyNextBtn">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚û°Ô∏è</button>
            </div>

            <div style="text-align: center; color: #888;">
                <span id="studyProgress">1</span> / <span id="studyTotal">0</span>
            </div>
        </div>

        <!-- Quiz Mode Content -->
        <div class="quiz-content" id="quizContent">
            <div class="quiz-question" id="quizQuestion">
                <p class="quiz-prompt">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏ï‡∏¥‡∏°‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á:</p>
                <p class="quiz-sentence" id="quizSentence">
                    ÊàëÊÉ≥ÂéªÁúãÁîµÂΩ±Ôºå<span class="blank">____</span>Ê≤°ÊúâÊó∂Èó¥„ÄÇ
                </p>
                <p class="quiz-translation" id="quizTranslation">‡∏â‡∏±‡∏ô‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏õ‡∏î‡∏π‡∏´‡∏ô‡∏±‡∏á ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤</p>
            </div>

            <div class="quiz-options" id="quizOptions">
                <!-- Options will be generated dynamically -->
            </div>

            <div class="quiz-feedback" id="quizFeedback">
                <h4 id="feedbackTitle">‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!</h4>
                <p id="feedbackText"></p>
            </div>

            <div class="grammar-nav">
                <button class="nav-btn primary" id="nextQuestionBtn" style="display: none;">‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚û°Ô∏è</button>
            </div>

            <!-- Quiz Complete -->
            <div class="quiz-complete" id="quizComplete">
                <h2>üéâ ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!</h2>
                <div class="quiz-complete-stats">
                    <div class="complete-stat">
                        <div class="complete-stat-value correct" id="finalCorrect">0</div>
                        <div class="complete-stat-label">‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å</div>
                    </div>
                    <div class="complete-stat">
                        <div class="complete-stat-value wrong" id="finalWrong">0</div>
                        <div class="complete-stat-label">‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î</div>
                    </div>
                </div>
                <p id="quizMessage">‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏°‡∏≤‡∏Å! ‡∏•‡∏≠‡∏á‡∏ó‡∏≥‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</p>
                <button class="nav-btn primary" id="restartQuizBtn">üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÉ‡∏´‡∏°‡πà</button>
            </div>
        </div>

        <!-- Drag Game Content -->
        <div class="drag-content" id="dragContent">
            <div class="drag-stats" id="dragStats">
                <span class="grammar-stat correct">‚úì ‡∏ñ‡∏π‡∏Å: <span id="dragCorrectCount">0</span></span>
                <span class="grammar-stat wrong">‚úó ‡∏ú‡∏¥‡∏î: <span id="dragWrongCount">0</span></span>
                <span class="grammar-stat total">üìö ‡∏Ç‡πâ‡∏≠: <span id="dragQuestionNum">1</span>/<span id="dragTotalQuestions">10</span></span>
            </div>

            <div class="grammar-progress">
                <div class="grammar-progress-bar" id="dragProgressFill" style="width: 0%"></div>
            </div>

            <div class="drag-game-card" id="dragGameCard">
                <p class="drag-instruction" id="dragQuestionType">‡∏•‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏°‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:</p>
                <div class="drag-translation" id="dragTranslation">‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</div>
                
                <!-- Match Mode Elements -->
                <div class="match-word" id="matchWord" style="display: none;"></div>
                <div class="match-options" id="matchOptions" style="display: none;"></div>
                
                <!-- Arrange Mode Elements -->
                <div class="drag-drop-zone" id="dropZone">
                    <span class="drop-placeholder">‡∏•‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</span>
                </div>

                <div class="drag-word-bank" id="wordBank">
                    <!-- Words will be generated dynamically -->
                </div>

                <div class="drag-feedback" id="dragFeedback">
                    <h4 id="dragFeedbackTitle">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</h4>
                    <p id="dragFeedbackText"></p>
                    <div class="drag-correct-answer" id="dragCorrectAnswer"></div>
                </div>

                <div class="drag-actions">
                    <button class="nav-btn" id="resetDragBtn">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button>
                    <button class="nav-btn primary" id="checkDragBtn">‚úì ‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö</button>
                    <button class="nav-btn primary" id="nextDragBtn" style="display: none;">‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚û°Ô∏è</button>
                </div>
            </div>

            <!-- Drag Game Complete -->
            <div class="quiz-complete" id="dragComplete">
                <h2>üéâ ‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏Å‡∏°‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!</h2>
                <div class="quiz-complete-stats">
                    <div class="complete-stat">
                        <div class="complete-stat-value correct" id="dragFinalCorrect">0</div>
                        <div class="complete-stat-label">‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å</div>
                    </div>
                    <div class="complete-stat">
                        <div class="complete-stat-value wrong" id="dragFinalWrong">0</div>
                        <div class="complete-stat-label">‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î</div>
                    </div>
                </div>
                <p id="dragMessage">‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏°‡∏≤‡∏Å!</p>
                <button class="nav-btn primary" id="restartDragBtn">üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà</button>
            </div>
        </div>

        <!-- Topic List -->
        <div class="topic-list" id="topicList">
            <div class="list-search-container">
                <input type="text" class="list-search-input" id="listSearchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå... (‡∏†‡∏≤‡∏©‡∏≤‡∏à‡∏µ‡∏ô, ‡∏û‡∏¥‡∏ô‡∏≠‡∏¥‡∏ô, ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢)">
            </div>
            <div class="search-results-count" id="searchResultsCount"></div>
            <div class="topic-grid" id="topicGrid">
                <!-- Topics will be generated dynamically -->
            </div>
        </div>

        <!-- Footer -->
        <footer class="grammar-footer">
            <p>Made with ‚ù§Ô∏è by <strong>PRNXT</strong></p>
        </footer>
    </div>

    <script src="grammar.js"></script>
    <script>
        // Global Variables
        let grammarPoints = [];
        let currentStudyIndex = 0;
        let currentQuizIndex = 0;
        let quizQuestions = [];
        let correctAnswers = 0;
        let wrongAnswers = 0;
        let currentMode = 'study'; // 'study', 'quiz', 'list', 'drag'

        // Drag Game Variables
        let dragQuestions = [];
        let currentDragIndex = 0;
        let dragCorrectAnswers = 0;
        let dragWrongAnswers = 0;
        let currentDraggedWord = null;

        // DOM Elements
        const studyModeBtn = document.getElementById('studyModeBtn');
        const quizModeBtn = document.getElementById('quizModeBtn');
        const listModeBtn = document.getElementById('listModeBtn');
        const dragModeBtn = document.getElementById('dragModeBtn');
        const studyContent = document.getElementById('studyContent');
        const quizContent = document.getElementById('quizContent');
        const topicList = document.getElementById('topicList');
        const dragContent = document.getElementById('dragContent');
        const quizStats = document.getElementById('quizStats');
        const progressBar = document.getElementById('progressBar');

        // Load grammar data
        async function loadGrammar() {
            try {
                // Try to load from embedded data first (for file:// protocol)
                if (typeof grammarData !== 'undefined' && grammarData !== null) {
                    grammarPoints = grammarData;
                } else {
                    // Try fetch (works with http:// and Live Server)
                    const response = await fetch('cn_grammar.json');
                    const data = await response.json();
                    grammarPoints = data.grammar_points || [];
                }
                
                document.getElementById('studyTotal').textContent = grammarPoints.length;
                
                if (grammarPoints.length > 0) {
                    displayStudyCard(0);
                    generateTopicList();
                }
            } catch (error) {
                console.error('Error loading grammar:', error);
                // Fallback to embedded data
                if (typeof grammarData !== 'undefined' && grammarData !== null) {
                    grammarPoints = grammarData;
                    document.getElementById('studyTotal').textContent = grammarPoints.length;
                    if (grammarPoints.length > 0) {
                        displayStudyCard(0);
                        generateTopicList();
                    }
                }
            }
        }

        // Mode switching
        function switchMode(mode) {
            currentMode = mode;
            
            // Update buttons
            studyModeBtn.classList.toggle('active', mode === 'study');
            quizModeBtn.classList.toggle('active', mode === 'quiz');
            listModeBtn.classList.toggle('active', mode === 'list');
            dragModeBtn.classList.toggle('active', mode === 'drag');

            // Update content visibility
            studyContent.classList.toggle('active', mode === 'study');
            quizContent.classList.toggle('active', mode === 'quiz');
            topicList.classList.toggle('active', mode === 'list');
            dragContent.classList.toggle('active', mode === 'drag');

            // Show/hide stats and progress
            quizStats.style.display = mode === 'quiz' ? 'flex' : 'none';
            progressBar.style.display = mode === 'quiz' ? 'block' : 'none';

            if (mode === 'quiz') {
                startQuiz();
            } else if (mode === 'drag') {
                startDragGame();
            } else if (mode === 'list') {
                filterTopicList('');
            }
        }

        studyModeBtn.addEventListener('click', () => switchMode('study'));
        quizModeBtn.addEventListener('click', () => switchMode('quiz'));
        listModeBtn.addEventListener('click', () => switchMode('list'));
        dragModeBtn.addEventListener('click', () => switchMode('drag'));

        // Study Mode Functions
        function displayStudyCard(index) {
            if (index < 0 || index >= grammarPoints.length) return;
            
            currentStudyIndex = index;
            const grammar = grammarPoints[index];

            document.getElementById('studyHanzi').textContent = grammar.hanzi;
            document.getElementById('studyPinyin').textContent = grammar.pinyin;
            document.getElementById('studyType').textContent = grammar.type;
            
            // Meaning
            const meanings = grammar.meaning_th;
            document.getElementById('studyMeaning').innerHTML = 
                Array.isArray(meanings) 
                    ? meanings.map(m => `<span>${m}</span>`).join(' ') 
                    : meanings;

            document.getElementById('studyUsage').textContent = grammar.usage_th;
            
            // Pattern
            const pattern = grammar.pattern;
            document.getElementById('studyPattern').innerHTML = 
                Array.isArray(pattern) 
                    ? pattern.join('<br>') 
                    : pattern;

            // Examples
            const examplesHtml = grammar.examples.map(ex => `
                <div class="example-item">
                    <div class="example-zh">${ex.zh}</div>
                    <div class="example-th">${ex.th}</div>
                </div>
            `).join('');
            document.getElementById('studyExamples').innerHTML = examplesHtml;

            // Update progress
            document.getElementById('studyProgress').textContent = index + 1;

            // Update navigation buttons
            document.getElementById('studyPrevBtn').disabled = index === 0;
            document.getElementById('studyNextBtn').disabled = index === grammarPoints.length - 1;
        }

        document.getElementById('studyPrevBtn').addEventListener('click', () => {
            if (currentStudyIndex > 0) {
                displayStudyCard(currentStudyIndex - 1);
            }
        });

        document.getElementById('studyNextBtn').addEventListener('click', () => {
            if (currentStudyIndex < grammarPoints.length - 1) {
                displayStudyCard(currentStudyIndex + 1);
            }
        });

        document.getElementById('studySoundBtn').addEventListener('click', () => {
            const hanzi = document.getElementById('studyHanzi').textContent;
            speakChinese(hanzi);
        });

        // Quiz Mode Functions
        function startQuiz() {
            correctAnswers = 0;
            wrongAnswers = 0;
            currentQuizIndex = 0;
            
            // Generate quiz questions
            quizQuestions = generateQuizQuestions();
            
            document.getElementById('totalQuestions').textContent = quizQuestions.length;
            document.getElementById('correctCount').textContent = 0;
            document.getElementById('wrongCount').textContent = 0;
            
            document.getElementById('quizQuestion').style.display = 'block';
            document.getElementById('quizOptions').style.display = 'grid';
            document.getElementById('quizComplete').classList.remove('active');
            
            displayQuizQuestion(0);
        }

        function generateQuizQuestions() {
            const questions = [];
            const shuffled = [...grammarPoints].sort(() => Math.random() - 0.5);
            const selected = shuffled.slice(0, Math.min(10, shuffled.length));

            // Question types: 1=fill blank, 2=choose meaning, 3=choose correct usage
            const questionTypes = [1, 2, 3, 1, 2, 3, 1, 2, 3, 1];

            selected.forEach((grammar, idx) => {
                const qType = questionTypes[idx % questionTypes.length];
                
                if (qType === 1 && grammar.examples && grammar.examples.length > 0) {
                    // Type 1: Fill in the blank
                    const example = grammar.examples[Math.floor(Math.random() * grammar.examples.length)];
                    const sentence = example.zh;
                    const answer = grammar.hanzi;
                    const blankSentence = sentence.replace(answer, '<span class="blank">____</span>');
                    
                    const wrongOptions = grammarPoints
                        .filter(g => g.hanzi !== answer)
                        .sort(() => Math.random() - 0.5)
                        .slice(0, 3)
                        .map(g => g.hanzi);

                    questions.push({
                        type: 'fill',
                        questionText: 'üìù ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á:',
                        sentence: blankSentence,
                        originalSentence: sentence,
                        translation: example.th,
                        answer: answer,
                        options: [...wrongOptions, answer].sort(() => Math.random() - 0.5),
                        grammar: grammar
                    });
                } else if (qType === 2) {
                    // Type 2: Choose correct meaning for the word
                    const meanings = Array.isArray(grammar.meaning_th) 
                        ? grammar.meaning_th.join(', ') 
                        : grammar.meaning_th;
                    
                    const wrongMeanings = grammarPoints
                        .filter(g => g.hanzi !== grammar.hanzi)
                        .sort(() => Math.random() - 0.5)
                        .slice(0, 3)
                        .map(g => Array.isArray(g.meaning_th) ? g.meaning_th[0] : g.meaning_th);

                    questions.push({
                        type: 'meaning',
                        questionText: 'üìñ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:',
                        sentence: `<span class="quiz-word-highlight">${grammar.hanzi}</span> <span class="quiz-pinyin">(${grammar.pinyin})</span>`,
                        originalSentence: grammar.hanzi,
                        translation: '',
                        answer: meanings,
                        options: [...wrongMeanings, meanings].sort(() => Math.random() - 0.5),
                        grammar: grammar
                    });
                } else if (qType === 3 && grammar.examples && grammar.examples.length > 0) {
                    // Type 3: Choose the sentence that correctly uses this grammar
                    const correctExample = grammar.examples[Math.floor(Math.random() * grammar.examples.length)];
                    
                    // Get wrong sentences from other grammars
                    const wrongSentences = grammarPoints
                        .filter(g => g.hanzi !== grammar.hanzi && g.examples && g.examples.length > 0)
                        .sort(() => Math.random() - 0.5)
                        .slice(0, 3)
                        .map(g => g.examples[0].zh);

                    questions.push({
                        type: 'usage',
                        questionText: `üéØ ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÉ‡∏î‡πÉ‡∏ä‡πâ "${grammar.hanzi}" ‡πÑ‡∏î‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á?`,
                        sentence: `‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå: <span class="quiz-word-highlight">${grammar.hanzi}</span> (${grammar.pinyin}) - ${Array.isArray(grammar.meaning_th) ? grammar.meaning_th[0] : grammar.meaning_th}`,
                        originalSentence: correctExample.zh,
                        translation: correctExample.th,
                        answer: correctExample.zh,
                        options: [...wrongSentences, correctExample.zh].sort(() => Math.random() - 0.5),
                        grammar: grammar
                    });
                } else if (grammar.examples && grammar.examples.length > 0) {
                    // Fallback to Type 1
                    const example = grammar.examples[Math.floor(Math.random() * grammar.examples.length)];
                    const sentence = example.zh;
                    const answer = grammar.hanzi;
                    const blankSentence = sentence.replace(answer, '<span class="blank">____</span>');
                    
                    const wrongOptions = grammarPoints
                        .filter(g => g.hanzi !== answer)
                        .sort(() => Math.random() - 0.5)
                        .slice(0, 3)
                        .map(g => g.hanzi);

                    questions.push({
                        type: 'fill',
                        questionText: 'üìù ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ñ‡∏≥‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á:',
                        sentence: blankSentence,
                        originalSentence: sentence,
                        translation: example.th,
                        answer: answer,
                        options: [...wrongOptions, answer].sort(() => Math.random() - 0.5),
                        grammar: grammar
                    });
                }
            });

            return questions;
        }

        function displayQuizQuestion(index) {
            if (index >= quizQuestions.length) {
                showQuizComplete();
                return;
            }

            const question = quizQuestions[index];
            currentQuizIndex = index;

            // Show question type header
            const questionTypeHtml = `<div class="quiz-type-label">${question.questionText}</div>`;
            document.getElementById('quizSentence').innerHTML = questionTypeHtml + question.sentence;
            document.getElementById('quizTranslation').textContent = question.translation;
            document.getElementById('questionNum').textContent = index + 1;

            // Update progress bar
            const progress = ((index) / quizQuestions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';

            // Generate options based on question type
            let optionsHtml;
            if (question.type === 'usage') {
                optionsHtml = question.options.map(option => `
                    <button class="quiz-option quiz-option-sentence" data-option="${option}">${option}</button>
                `).join('');
            } else {
                optionsHtml = question.options.map(option => `
                    <button class="quiz-option" data-option="${option}">${option}</button>
                `).join('');
            }
            document.getElementById('quizOptions').innerHTML = optionsHtml;

            // Add click events
            document.querySelectorAll('.quiz-option').forEach(btn => {
                btn.addEventListener('click', () => handleAnswer(btn, question));
            });

            // Hide feedback and next button
            document.getElementById('quizFeedback').classList.remove('show', 'correct', 'wrong');
            document.getElementById('nextQuestionBtn').style.display = 'none';
        }

        function handleAnswer(selectedBtn, question) {
            const selected = selectedBtn.dataset.option;
            const isCorrect = selected === question.answer;

            // Disable all options
            document.querySelectorAll('.quiz-option').forEach(btn => {
                btn.classList.add('disabled');
                if (btn.dataset.option === question.answer) {
                    btn.classList.add('correct');
                } else if (btn === selectedBtn && !isCorrect) {
                    btn.classList.add('wrong');
                }
            });

            // Update stats
            if (isCorrect) {
                correctAnswers++;
                document.getElementById('correctCount').textContent = correctAnswers;
            } else {
                wrongAnswers++;
                document.getElementById('wrongCount').textContent = wrongAnswers;
            }

            // Show feedback
            const feedback = document.getElementById('quizFeedback');
            feedback.classList.add('show', isCorrect ? 'correct' : 'wrong');
            document.getElementById('feedbackTitle').textContent = isCorrect ? '‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!' : '‚ùå ‡∏ú‡∏¥‡∏î!';
            document.getElementById('feedbackText').innerHTML = `
                <strong>${question.answer}</strong> (${question.grammar.pinyin})<br>
                ${question.grammar.usage_th}
            `;

            // Show next button
            document.getElementById('nextQuestionBtn').style.display = 'inline-flex';
        }

        document.getElementById('nextQuestionBtn').addEventListener('click', () => {
            displayQuizQuestion(currentQuizIndex + 1);
        });

        function showQuizComplete() {
            document.getElementById('quizQuestion').style.display = 'none';
            document.getElementById('quizOptions').style.display = 'none';
            document.getElementById('quizFeedback').classList.remove('show');
            document.getElementById('nextQuestionBtn').style.display = 'none';
            
            document.getElementById('quizComplete').classList.add('active');
            document.getElementById('finalCorrect').textContent = correctAnswers;
            document.getElementById('finalWrong').textContent = wrongAnswers;

            // Update progress to 100%
            document.getElementById('progressFill').style.width = '100%';

            const percentage = (correctAnswers / quizQuestions.length) * 100;
            let message = '';
            if (percentage >= 90) message = 'üåü ‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å! ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å!';
            else if (percentage >= 70) message = 'üëè ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ! ‡∏•‡∏≠‡∏á‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î';
            else if (percentage >= 50) message = 'üí™ ‡∏û‡∏≠‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ! ‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡∏∞';
            else message = 'üìö ‡∏•‡∏≠‡∏á‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
            
            document.getElementById('quizMessage').textContent = message;
        }

        document.getElementById('restartQuizBtn').addEventListener('click', startQuiz);

        // Topic List Functions
        function generateTopicList() {
            const grid = document.getElementById('topicGrid');
            grid.innerHTML = grammarPoints.map((grammar, index) => `
                <div class="topic-item" data-index="${index}">
                    <div class="topic-hanzi">${grammar.hanzi}</div>
                    <div class="topic-pinyin">${grammar.pinyin}</div>
                    <div class="topic-meaning">${Array.isArray(grammar.meaning_th) ? grammar.meaning_th.join(', ') : grammar.meaning_th}</div>
                </div>
            `).join('');

            addTopicClickEvents();
        }

        function addTopicClickEvents() {
            document.querySelectorAll('.topic-item').forEach(item => {
                item.addEventListener('click', () => {
                    const index = parseInt(item.dataset.index);
                    currentStudyIndex = index;
                    displayStudyCard(index);
                    switchMode('study');
                });
            });
        }

        // Search/Filter Topic List
        function filterTopicList(query) {
            const grid = document.getElementById('topicGrid');
            const searchTerm = query.toLowerCase().trim();
            
            let filtered = grammarPoints;
            if (searchTerm) {
                filtered = grammarPoints.filter((grammar, index) => {
                    const hanzi = grammar.hanzi.toLowerCase();
                    const pinyin = grammar.pinyin.toLowerCase();
                    const meanings = Array.isArray(grammar.meaning_th) 
                        ? grammar.meaning_th.join(' ').toLowerCase() 
                        : grammar.meaning_th.toLowerCase();
                    const usage = grammar.usage_th.toLowerCase();
                    const type = grammar.type.toLowerCase();
                    
                    return hanzi.includes(searchTerm) || 
                           pinyin.includes(searchTerm) || 
                           meanings.includes(searchTerm) ||
                           usage.includes(searchTerm) ||
                           type.includes(searchTerm);
                });
            }

            // Update results count
            const countEl = document.getElementById('searchResultsCount');
            if (searchTerm) {
                countEl.textContent = `‡∏û‡∏ö ${filtered.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å ${grammarPoints.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            } else {
                countEl.textContent = `‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${grammarPoints.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            }

            // Render filtered list
            grid.innerHTML = filtered.map((grammar) => {
                const originalIndex = grammarPoints.indexOf(grammar);
                return `
                    <div class="topic-item" data-index="${originalIndex}">
                        <div class="topic-hanzi">${grammar.hanzi}</div>
                        <div class="topic-pinyin">${grammar.pinyin}</div>
                        <div class="topic-meaning">${Array.isArray(grammar.meaning_th) ? grammar.meaning_th.join(', ') : grammar.meaning_th}</div>
                    </div>
                `;
            }).join('');

            addTopicClickEvents();
        }

        // Search input event
        document.getElementById('listSearchInput').addEventListener('input', (e) => {
            filterTopicList(e.target.value);
        });

        // ==================== DRAG GAME FUNCTIONS ====================

        function startDragGame() {
            dragCorrectAnswers = 0;
            dragWrongAnswers = 0;
            currentDragIndex = 0;
            
            // Generate drag questions from examples
            dragQuestions = generateDragQuestions();
            
            document.getElementById('dragTotalQuestions').textContent = dragQuestions.length;
            document.getElementById('dragCorrectCount').textContent = 0;
            document.getElementById('dragWrongCount').textContent = 0;
            
            document.getElementById('dragGameCard').style.display = 'block';
            document.getElementById('dragComplete').classList.remove('active');
            document.getElementById('dragStats').style.display = 'flex';
            
            displayDragQuestion(0);
        }

        function generateDragQuestions() {
            const questions = [];
            const shuffled = [...grammarPoints].sort(() => Math.random() - 0.5);
            const selected = shuffled.slice(0, Math.min(10, shuffled.length));

            // Question types: 1=arrange sentence, 2=match pairs
            const questionTypes = [1, 2, 1, 2, 1, 2, 1, 2, 1, 2];

            selected.forEach((grammar, idx) => {
                const qType = questionTypes[idx % questionTypes.length];

                if (qType === 1 && grammar.examples && grammar.examples.length > 0) {
                    // Type 1: Arrange words to form sentence
                    const example = grammar.examples[Math.floor(Math.random() * grammar.examples.length)];
                    const sentence = example.zh.replace(/[Ôºå„ÄÇÔºÅÔºü„ÄÅÔºõÔºö""''ÔºàÔºâ]/g, '');
                    const words = segmentChinese(sentence);
                    
                    if (words.length >= 3) {
                        questions.push({
                            type: 'arrange',
                            questionText: 'üìù ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ:',
                            originalSentence: example.zh,
                            translation: example.th,
                            words: words,
                            shuffledWords: [...words].sort(() => Math.random() - 0.5),
                            grammar: grammar
                        });
                    }
                } else if (qType === 2) {
                    // Type 2: Match Chinese to Thai (select correct meaning)
                    const meanings = Array.isArray(grammar.meaning_th) 
                        ? grammar.meaning_th.join(', ') 
                        : grammar.meaning_th;
                    
                    // Get 3 wrong meanings
                    const wrongMeanings = grammarPoints
                        .filter(g => g.hanzi !== grammar.hanzi)
                        .sort(() => Math.random() - 0.5)
                        .slice(0, 3)
                        .map(g => Array.isArray(g.meaning_th) ? g.meaning_th[0] : g.meaning_th);
                    
                    const allOptions = [...wrongMeanings, meanings].sort(() => Math.random() - 0.5);

                    questions.push({
                        type: 'match',
                        questionText: 'üîó ‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢:',
                        originalSentence: grammar.hanzi,
                        translation: meanings,
                        hanzi: grammar.hanzi,
                        pinyin: grammar.pinyin,
                        options: allOptions,
                        grammar: grammar
                    });
                }
            });

            // Ensure at least some questions exist
            if (questions.length === 0) {
                shuffled.slice(0, 5).forEach(grammar => {
                    if (grammar.examples && grammar.examples.length > 0) {
                        const example = grammar.examples[0];
                        const sentence = example.zh.replace(/[Ôºå„ÄÇÔºÅÔºü„ÄÅÔºõÔºö""''ÔºàÔºâ]/g, '');
                        const words = segmentChinese(sentence);
                        
                        if (words.length >= 3) {
                            questions.push({
                                type: 'arrange',
                                questionText: 'üìù ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡∏≥‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ:',
                                originalSentence: example.zh,
                                translation: example.th,
                                words: words,
                                shuffledWords: [...words].sort(() => Math.random() - 0.5),
                                grammar: grammar
                            });
                        }
                    }
                });
            }

            return questions;
        }

        // Simple Chinese segmentation (by common patterns)
        function segmentChinese(sentence) {
            // Try to segment into meaningful chunks
            // This is a simplified version - for better results, use a proper library
            const words = [];
            let i = 0;
            
            while (i < sentence.length) {
                // Try 4-char, 3-char, 2-char, then 1-char
                let found = false;
                for (let len = 4; len >= 1; len--) {
                    if (i + len <= sentence.length) {
                        const chunk = sentence.slice(i, i + len);
                        // Check if it's a common word/phrase pattern
                        if (len > 1 && isLikelyWord(chunk, len)) {
                            words.push(chunk);
                            i += len;
                            found = true;
                            break;
                        }
                    }
                }
                if (!found) {
                    words.push(sentence[i]);
                    i++;
                }
            }
            
            // Merge single characters if too many small segments
            if (words.length > 8) {
                return mergeSmallSegments(words);
            }
            
            return words;
        }

        function isLikelyWord(chunk, len) {
            // Common 2-char patterns
            const common2 = ['Êàë‰ª¨', '‰Ω†‰ª¨', '‰ªñ‰ª¨', 'Â•π‰ª¨', '‰ªÄ‰πà', 'ÊÄé‰πà', '‰∏∫‰ªÄ‰πà', 'ÂèØ‰ª•', 'Â∫îËØ•', 'ÈúÄË¶Å', 'Áü•ÈÅì', 'ËßâÂæó', 'ÂñúÊ¨¢', 'ËÆ§‰∏∫', 'Â∑≤Áªè', 'Ê≠£Âú®', '‰∏ÄËµ∑', '‰∏ÄÁõ¥', '‰∏ÄÂÆö', '‰∏ÄËæπ', 'Â¶ÇÊûú', 'ËôΩÁÑ∂', '‰ΩÜÊòØ', 'Âõ†‰∏∫', 'ÊâÄ‰ª•', 'ËÄå‰∏î', 'ÁÑ∂Âêé', 'Áé∞Âú®', '‰ª•Âêé', '‰ª•Ââç', 'Ëøô‰∏™', 'ÈÇ£‰∏™', 'Ëá™Â∑±', 'Â§ßÂÆ∂', 'Êó∂ÂÄô', 'Âú∞Êñπ', '‰∏úË•ø', 'Â∑•‰Ωú', 'Â≠¶‰π†', 'ÁîµÂΩ±', 'Èü≥‰πê', 'ÊúãÂèã', 'ÂÆ∂‰∫∫', 'ËÄÅÂ∏à', 'Â≠¶Áîü', 'ÈóÆÈ¢ò', 'Êó∂Èó¥', '‰ªäÂ§©', 'ÊòéÂ§©', 'Êò®Â§©', 'ÊØèÂ§©', 'ÈùûÂ∏∏', 'ÁâπÂà´', 'ÁúüÁöÑ', 'ÂÖ∂ÂÆû', 'ÂéüÊù•', 'Âè™ÊòØ', 'ËøòÊòØ', 'ÊàñËÄÖ', '‰∏çËøá', '‰∏ç‰ΩÜ', '‰ªéÊù•', '‰ª•‰∏∫', 'Ê≠£Â•Ω', 'Âá†‰πé', '‰∏ÄÂÖ±', 'Áªà‰∫é', 'È©¨‰∏ä', 'ÁªèÂ∏∏', 'ÊÄªÊòØ'];
            
            // Common 3-char patterns  
            const common3 = ['ÊÄé‰πàÊ†∑', '‰∏∫‰ªÄ‰πà', 'Ê≤°ÂÖ≥Á≥ª', '‰∏çÂ•ΩÊÑèÊÄù', 'ÂØπ‰∏çËµ∑'];
            
            // Common 4-char patterns
            const common4 = ['Ë∂äÊù•Ë∂ä', 'Ê≤°ÊúâÈóÆÈ¢ò'];
            
            if (len === 2) return common2.includes(chunk) || /^[‰∏Ä-Èæ•]{2}$/.test(chunk);
            if (len === 3) return common3.includes(chunk);
            if (len === 4) return common4.includes(chunk);
            
            return false;
        }

        function mergeSmallSegments(words) {
            const merged = [];
            let temp = '';
            
            for (let word of words) {
                if (word.length === 1 && temp.length < 2) {
                    temp += word;
                } else {
                    if (temp) {
                        merged.push(temp);
                        temp = '';
                    }
                    if (word.length === 1) {
                        temp = word;
                    } else {
                        merged.push(word);
                    }
                }
            }
            if (temp) merged.push(temp);
            
            return merged;
        }

        function displayDragQuestion(index) {
            if (index >= dragQuestions.length) {
                showDragComplete();
                return;
            }

            const question = dragQuestions[index];
            currentDragIndex = index;

            document.getElementById('dragQuestionNum').textContent = index + 1;

            // Update progress bar
            const progress = (index / dragQuestions.length) * 100;
            document.getElementById('dragProgressFill').style.width = progress + '%';

            // Reset feedback and buttons
            document.getElementById('dragFeedback').classList.remove('show', 'correct', 'wrong');
            document.getElementById('nextDragBtn').style.display = 'none';

            const dragGameCard = document.getElementById('dragGameCard');

            if (question.type === 'arrange') {
                // Type 1: Arrange sentence
                document.getElementById('dragQuestionType').textContent = question.questionText;
                document.getElementById('dragTranslation').textContent = question.translation;
                document.getElementById('dragTranslation').style.display = 'block';
                
                // Show drag elements
                document.getElementById('dropZone').style.display = 'flex';
                document.getElementById('wordBank').style.display = 'flex';
                document.getElementById('matchOptions').style.display = 'none';
                document.getElementById('matchWord').style.display = 'none';

                // Reset drop zone
                const dropZone = document.getElementById('dropZone');
                dropZone.innerHTML = '<span class="drop-placeholder">‡∏•‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</span>';
                dropZone.classList.remove('correct', 'wrong');

                // Generate word bank with shuffled words
                const wordBank = document.getElementById('wordBank');
                wordBank.innerHTML = question.shuffledWords.map((word, idx) => `
                    <div class="drag-word" draggable="true" data-word="${word}" data-idx="${idx}">${word}</div>
                `).join('');

                // Add drag events
                setupDragEvents();

                document.getElementById('checkDragBtn').style.display = 'inline-flex';
                document.getElementById('resetDragBtn').style.display = 'inline-flex';
            } else if (question.type === 'match') {
                // Type 2: Match word to meaning
                document.getElementById('dragQuestionType').textContent = question.questionText;
                document.getElementById('dragTranslation').style.display = 'none';
                
                // Hide drag elements, show match elements
                document.getElementById('dropZone').style.display = 'none';
                document.getElementById('wordBank').style.display = 'none';
                document.getElementById('matchOptions').style.display = 'grid';
                document.getElementById('matchWord').style.display = 'block';

                // Show word to match
                document.getElementById('matchWord').innerHTML = `
                    <span class="match-hanzi">${question.hanzi}</span>
                    <span class="match-pinyin">${question.pinyin}</span>
                `;

                // Generate options
                const matchOptions = document.getElementById('matchOptions');
                matchOptions.innerHTML = question.options.map(opt => `
                    <button class="match-option" data-meaning="${opt}">${opt}</button>
                `).join('');

                // Add click events
                document.querySelectorAll('.match-option').forEach(btn => {
                    btn.addEventListener('click', () => handleMatchAnswer(btn, question));
                });

                document.getElementById('checkDragBtn').style.display = 'none';
                document.getElementById('resetDragBtn').style.display = 'none';
            }
        }

        function handleMatchAnswer(selectedBtn, question) {
            const selected = selectedBtn.dataset.meaning;
            const isCorrect = selected === question.translation;

            // Disable all options
            document.querySelectorAll('.match-option').forEach(btn => {
                btn.classList.add('disabled');
                if (btn.dataset.meaning === question.translation) {
                    btn.classList.add('correct');
                } else if (btn === selectedBtn && !isCorrect) {
                    btn.classList.add('wrong');
                }
            });

            // Update stats
            if (isCorrect) {
                dragCorrectAnswers++;
                document.getElementById('dragCorrectCount').textContent = dragCorrectAnswers;
            } else {
                dragWrongAnswers++;
                document.getElementById('dragWrongCount').textContent = dragWrongAnswers;
            }

            // Show feedback
            const feedback = document.getElementById('dragFeedback');
            feedback.classList.add('show', isCorrect ? 'correct' : 'wrong');
            document.getElementById('dragFeedbackTitle').textContent = isCorrect ? '‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!' : '‚ùå ‡∏ú‡∏¥‡∏î!';
            document.getElementById('dragFeedbackText').innerHTML = `
                <strong>${question.hanzi}</strong> (${question.pinyin})<br>
                ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢: ${question.translation}
            `;

            document.getElementById('nextDragBtn').style.display = 'inline-flex';
        }

        function setupDragEvents() {
            const words = document.querySelectorAll('.drag-word');
            const dropZone = document.getElementById('dropZone');
            const wordBank = document.getElementById('wordBank');

            words.forEach(word => {
                // Drag start
                word.addEventListener('dragstart', (e) => {
                    currentDraggedWord = word;
                    word.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                });

                // Drag end
                word.addEventListener('dragend', () => {
                    word.classList.remove('dragging');
                    currentDraggedWord = null;
                });

                // Touch events for mobile
                word.addEventListener('touchstart', handleTouchStart, { passive: false });
                word.addEventListener('touchmove', handleTouchMove, { passive: false });
                word.addEventListener('touchend', handleTouchEnd);
            });

            // Drop zone events
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                
                if (currentDraggedWord) {
                    // Remove placeholder if exists
                    const placeholder = dropZone.querySelector('.drop-placeholder');
                    if (placeholder) placeholder.remove();

                    // Move word to drop zone
                    const wordClone = currentDraggedWord.cloneNode(true);
                    wordClone.classList.add('placed', 'in-zone');
                    wordClone.classList.remove('dragging');
                    
                    // Add click to remove from zone
                    wordClone.addEventListener('click', () => {
                        moveWordBackToBank(wordClone);
                    });

                    dropZone.appendChild(wordClone);
                    currentDraggedWord.style.display = 'none';
                }
            });

            // Allow dropping back to word bank
            wordBank.addEventListener('dragover', (e) => {
                e.preventDefault();
            });

            wordBank.addEventListener('drop', (e) => {
                e.preventDefault();
                if (currentDraggedWord && currentDraggedWord.classList.contains('in-zone')) {
                    moveWordBackToBank(currentDraggedWord);
                }
            });
        }

        // Touch handling for mobile
        let touchStartX, touchStartY, touchElement, dragGhost;

        function handleTouchStart(e) {
            touchElement = e.target.closest('.drag-word');
            if (!touchElement) return;
            
            e.preventDefault();
            
            const touch = e.touches[0];
            touchStartX = touch.clientX;
            touchStartY = touch.clientY;
            
            // Mark original as active
            touchElement.classList.add('touch-active');
            
            // Create ghost element that follows finger
            dragGhost = document.createElement('div');
            dragGhost.className = 'drag-ghost';
            dragGhost.textContent = touchElement.textContent;
            dragGhost.style.left = touch.clientX + 'px';
            dragGhost.style.top = touch.clientY + 'px';
            document.body.appendChild(dragGhost);
        }

        function handleTouchMove(e) {
            if (!touchElement || !dragGhost) return;
            e.preventDefault();
            
            const touch = e.touches[0];
            
            // Move ghost to follow finger
            dragGhost.style.left = touch.clientX + 'px';
            dragGhost.style.top = touch.clientY + 'px';
            
            // Check if over drop zone
            const dropZone = document.getElementById('dropZone');
            const rect = dropZone.getBoundingClientRect();
            
            if (touch.clientX >= rect.left && touch.clientX <= rect.right &&
                touch.clientY >= rect.top && touch.clientY <= rect.bottom) {
                dropZone.classList.add('drag-over');
            } else {
                dropZone.classList.remove('drag-over');
            }
        }

        function handleTouchEnd(e) {
            if (!touchElement) return;
            
            const dropZone = document.getElementById('dropZone');
            dropZone.classList.remove('drag-over');
            touchElement.classList.remove('touch-active');
            
            // Remove ghost
            if (dragGhost) {
                dragGhost.remove();
                dragGhost = null;
            }
            
            const touch = e.changedTouches[0];
            const rect = dropZone.getBoundingClientRect();
            
            if (touch.clientX >= rect.left && touch.clientX <= rect.right &&
                touch.clientY >= rect.top && touch.clientY <= rect.bottom) {
                // Drop in zone
                const placeholder = dropZone.querySelector('.drop-placeholder');
                if (placeholder) placeholder.remove();

                if (!touchElement.classList.contains('in-zone')) {
                    const wordClone = touchElement.cloneNode(true);
                    wordClone.classList.add('placed', 'in-zone');
                    wordClone.classList.remove('touch-active');
                    wordClone.addEventListener('click', () => {
                        moveWordBackToBank(wordClone);
                    });
                    dropZone.appendChild(wordClone);
                    touchElement.style.display = 'none';
                }
            }
            
            touchElement = null;
        }

        function moveWordBackToBank(wordEl) {
            const word = wordEl.dataset.word;
            const idx = wordEl.dataset.idx;
            
            // Show original in word bank
            const original = document.querySelector(`.drag-word[data-idx="${idx}"]:not(.in-zone)`);
            if (original) {
                original.style.display = 'block';
            }
            
            // Remove from drop zone
            wordEl.remove();

            // Add placeholder back if empty
            const dropZone = document.getElementById('dropZone');
            if (dropZone.children.length === 0) {
                dropZone.innerHTML = '<span class="drop-placeholder">‡∏•‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</span>';
            }
        }

        function checkDragAnswer() {
            const question = dragQuestions[currentDragIndex];
            
            // Only for arrange type
            if (question.type !== 'arrange') return;
            
            const dropZone = document.getElementById('dropZone');
            const placedWords = Array.from(dropZone.querySelectorAll('.drag-word')).map(el => el.dataset.word);
            
            // Check if answer matches
            const userAnswer = placedWords.join('');
            const correctAnswer = question.words.join('');
            const isCorrect = userAnswer === correctAnswer;

            // Update stats
            if (isCorrect) {
                dragCorrectAnswers++;
                document.getElementById('dragCorrectCount').textContent = dragCorrectAnswers;
                dropZone.classList.add('correct');
            } else {
                dragWrongAnswers++;
                document.getElementById('dragWrongCount').textContent = dragWrongAnswers;
                dropZone.classList.add('wrong');
            }

            // Show feedback
            const feedback = document.getElementById('dragFeedback');
            feedback.classList.add('show', isCorrect ? 'correct' : 'wrong');
            document.getElementById('dragFeedbackTitle').textContent = isCorrect ? '‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!' : '‚ùå ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
            document.getElementById('dragFeedbackText').innerHTML = isCorrect 
                ? `<strong>${question.originalSentence}</strong>` 
                : `‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å: <strong>${question.originalSentence}</strong>`;
            document.getElementById('dragCorrectAnswer').textContent = '';

            // Update buttons
            document.getElementById('checkDragBtn').style.display = 'none';
            document.getElementById('resetDragBtn').style.display = 'none';
            document.getElementById('nextDragBtn').style.display = 'inline-flex';
        }

        function resetDragQuestion() {
            displayDragQuestion(currentDragIndex);
        }

        function showDragComplete() {
            document.getElementById('dragGameCard').style.display = 'none';
            document.getElementById('dragComplete').classList.add('active');
            document.getElementById('dragFinalCorrect').textContent = dragCorrectAnswers;
            document.getElementById('dragFinalWrong').textContent = dragWrongAnswers;

            // Update progress to 100%
            document.getElementById('dragProgressFill').style.width = '100%';

            const percentage = (dragCorrectAnswers / dragQuestions.length) * 100;
            let message = '';
            if (percentage >= 90) message = 'üåü ‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å! ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å!';
            else if (percentage >= 70) message = 'üëè ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ! ‡∏•‡∏≠‡∏á‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏µ‡∏Å‡∏ô‡∏¥‡∏î';
            else if (percentage >= 50) message = 'üí™ ‡∏û‡∏≠‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ! ‡∏ù‡∏∂‡∏Å‡∏ù‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡∏∞';
            else message = 'üìö ‡∏•‡∏≠‡∏á‡∏ó‡∏ö‡∏ó‡∏ß‡∏ô‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
            
            document.getElementById('dragMessage').textContent = message;
        }

        // Drag game event listeners
        document.getElementById('checkDragBtn').addEventListener('click', checkDragAnswer);
        document.getElementById('resetDragBtn').addEventListener('click', resetDragQuestion);
        document.getElementById('nextDragBtn').addEventListener('click', () => {
            displayDragQuestion(currentDragIndex + 1);
        });
        document.getElementById('restartDragBtn').addEventListener('click', startDragGame);

        // Text to Speech
        function speakChinese(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-CN';
                utterance.rate = 0.8;
                window.speechSynthesis.speak(utterance);
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (currentMode === 'study') {
                if (e.key === 'ArrowLeft') {
                    document.getElementById('studyPrevBtn').click();
                } else if (e.key === 'ArrowRight') {
                    document.getElementById('studyNextBtn').click();
                }
            }
        });

        // Initialize
        loadGrammar();
    </script>
</body>
</html>
