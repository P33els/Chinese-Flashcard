<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Listening - Âê¨ÂäõÁªÉ‰π†</title>
    <link rel="stylesheet" href="styles.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Noto+Sans+Thai:wght@400;600&display=swap"
        rel="stylesheet">
    <script src="theme.js"></script>
    <style>
        .listening-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            border-radius: 25px;
            border: 2px solid rgba(212, 175, 55, 0.3);
            background: transparent;
            color: #d4af37;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            margin-bottom: 20px;
        }

        .back-btn:hover {
            background: rgba(212, 175, 55, 0.1);
            border-color: #d4af37;
        }

        .listening-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .listening-header h1 {
            font-size: 2rem;
            color: var(--text-hanzi);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 10px;
        }

        .listening-header p {
            color: #a0a0a0;
        }

        /* Mode Selection */
        .mode-selection {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .mode-btn {
            padding: 14px 28px;
            border-radius: 12px;
            border: 2px solid rgba(136, 192, 208, 0.3);
            background: transparent;
            color: #88c0d0;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .mode-btn:hover {
            background: rgba(136, 192, 208, 0.1);
        }

        .mode-btn.active {
            background: linear-gradient(135deg, #88c0d0, #5e9bb0);
            color: #1a1a1a;
            border-color: #88c0d0;
        }

        /* Content Area */
        .listen-content {
            display: none;
        }

        .listen-content.active {
            display: block;
        }

        /* Listen Card */
        .listen-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.05), rgba(0, 0, 0, 0.2));
            border-radius: 20px;
            padding: 30px;
            border: 2px solid rgba(136, 192, 208, 0.2);
            margin-bottom: 24px;
        }

        /* Current Item Info */
        .listen-current-info {
            text-align: center;
            margin-bottom: 30px;
        }

        .listen-hanzi {
            font-size: 4rem;
            color: var(--text-hanzi);
            font-family: 'Noto Serif SC', serif;
            margin-bottom: 10px;
        }

        .listen-pinyin {
            color: #88c0d0;
            font-size: 1.4rem;
            margin-bottom: 10px;
        }

        .listen-type {
            display: inline-block;
            background: rgba(136, 192, 208, 0.2);
            color: #88c0d0;
            padding: 4px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-bottom: 16px;
        }

        .listen-meaning {
            color: #c0b090;
            font-size: 1.1rem;
        }

        /* Main Play Button */
        .listen-play-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .listen-main-btn {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            border: 4px solid #88c0d0;
            background: linear-gradient(145deg, rgba(136, 192, 208, 0.2), rgba(136, 192, 208, 0.1));
            color: #88c0d0;
            font-size: 3.5rem;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .listen-main-btn:hover {
            background: linear-gradient(145deg, rgba(136, 192, 208, 0.3), rgba(136, 192, 208, 0.2));
            transform: scale(1.05);
            box-shadow: 0 0 40px rgba(136, 192, 208, 0.4);
        }

        .listen-main-btn:active {
            transform: scale(0.95);
        }

        .listen-main-btn.playing {
            animation: pulse 1s infinite;
            border-color: #2ed573;
            color: #2ed573;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(46, 213, 115, 0.4);
            }

            70% {
                box-shadow: 0 0 0 25px rgba(46, 213, 115, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(46, 213, 115, 0);
            }
        }

        /* Speed Control */
        .listen-speed-control {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .listen-speed-label {
            color: #888;
            font-size: 0.9rem;
        }

        .speed-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 2px solid rgba(136, 192, 208, 0.3);
            background: transparent;
            color: #88c0d0;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .speed-btn.active {
            background: rgba(136, 192, 208, 0.2);
            border-color: #88c0d0;
        }

        .speed-btn:hover {
            background: rgba(136, 192, 208, 0.1);
        }

        /* Auto Play Section */
        .listen-auto-section {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .auto-btn {
            padding: 12px 24px;
            border-radius: 25px;
            border: 2px solid rgba(46, 213, 115, 0.4);
            background: transparent;
            color: #2ed573;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .auto-btn:hover {
            background: rgba(46, 213, 115, 0.1);
            border-color: #2ed573;
        }

        .auto-btn.playing {
            background: rgba(46, 213, 115, 0.2);
        }

        .auto-btn.stop {
            border-color: rgba(255, 71, 87, 0.4);
            color: #ff4757;
        }

        .auto-btn.stop:hover {
            background: rgba(255, 71, 87, 0.1);
            border-color: #ff4757;
        }

        /* Sentences Section */
        .sentences-section {
            margin-top: 30px;
        }

        .sentences-title {
            color: #d4af37;
            font-size: 1.1rem;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sentence-item {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
            gap: 14px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .sentence-item:hover {
            border-color: rgba(136, 192, 208, 0.3);
            background: rgba(136, 192, 208, 0.05);
        }

        .sentence-item.playing {
            border-color: #2ed573;
            background: rgba(46, 213, 115, 0.1);
        }

        .sentence-play-btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 2px solid #88c0d0;
            background: transparent;
            color: #88c0d0;
            font-size: 1.3rem;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sentence-play-btn:hover {
            background: rgba(136, 192, 208, 0.2);
            transform: scale(1.05);
        }

        .sentence-play-btn.playing {
            border-color: #2ed573;
            color: #2ed573;
            animation: pulse 1s infinite;
        }

        .sentence-content {
            flex: 1;
        }

        .sentence-zh {
            font-family: 'Noto Serif SC', serif;
            font-size: 1.25rem;
            color: #f5f0e6;
            margin-bottom: 8px;
            line-height: 1.6;
        }

        .sentence-th {
            color: #888;
            font-size: 0.95rem;
        }

        /* Navigation */
        .listen-nav {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 24px;
        }

        .nav-btn {
            padding: 14px 28px;
            border-radius: 12px;
            border: 2px solid rgba(136, 192, 208, 0.3);
            background: transparent;
            color: #88c0d0;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            background: rgba(136, 192, 208, 0.1);
            border-color: #88c0d0;
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nav-btn.primary {
            background: linear-gradient(135deg, #88c0d0, #5e9bb0);
            color: #1a1a1a;
            border-color: #88c0d0;
        }

        .nav-btn.primary:hover {
            box-shadow: 0 4px 15px rgba(136, 192, 208, 0.4);
        }

        .listen-progress {
            text-align: center;
            color: #888;
            margin-top: 16px;
        }

        /* Quiz Sub-mode Selection */
        .quiz-submode-selection {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .quiz-submode-btn {
            padding: 12px 24px;
            border-radius: 25px;
            border: 2px solid rgba(136, 192, 208, 0.3);
            background: transparent;
            color: #88c0d0;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quiz-submode-btn:hover {
            background: rgba(136, 192, 208, 0.1);
            border-color: #88c0d0;
        }

        .quiz-submode-btn.active {
            background: linear-gradient(135deg, #88c0d0, #5e9bb0);
            color: #1a1a1a;
            border-color: #88c0d0;
        }

        /* Quiz Mode Styles */
        .quiz-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.05), rgba(0, 0, 0, 0.2));
            border-radius: 20px;
            padding: 30px;
            border: 2px solid rgba(212, 175, 55, 0.2);
            margin-bottom: 24px;
            text-align: center;
        }

        .quiz-prompt {
            color: #a0a0a0;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .quiz-play-btn {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 4px solid #d4af37;
            background: linear-gradient(145deg, rgba(212, 175, 55, 0.2), rgba(212, 175, 55, 0.1));
            color: #d4af37;
            font-size: 2.5rem;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
        }

        .quiz-play-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 30px rgba(212, 175, 55, 0.4);
        }

        .quiz-play-btn.playing {
            animation: pulse 1s infinite;
            border-color: #2ed573;
            color: #2ed573;
        }

        .quiz-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        @media (max-width: 600px) {
            .quiz-options {
                grid-template-columns: 1fr;
            }
        }

        .quiz-option {
            padding: 20px;
            border-radius: 12px;
            border: 2px solid rgba(212, 175, 55, 0.3);
            background: rgba(0, 0, 0, 0.2);
            color: #f5f0e6;
            font-size: 1.3rem;
            font-family: 'Noto Serif SC', serif;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quiz-option-thai {
            font-family: 'Noto Sans Thai', sans-serif;
            font-size: 1rem;
            text-align: left;
            line-height: 1.5;
        }

        .quiz-option-pinyin-choice {
            font-family: 'Noto Sans Thai', sans-serif;
            font-size: 1.2rem;
            color: #88c0d0;
        }

        .quiz-option:hover:not(.disabled) {
            border-color: #d4af37;
            background: rgba(212, 175, 55, 0.1);
            transform: translateY(-2px);
        }

        .quiz-option.correct {
            border-color: #2ed573;
            background: rgba(46, 213, 115, 0.2);
            color: #2ed573;
        }

        .quiz-option.wrong {
            border-color: #ff4757;
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
        }

        .quiz-option.disabled {
            pointer-events: none;
            opacity: 0.7;
        }

        .quiz-option-pinyin {
            font-family: 'Noto Sans Thai', sans-serif;
            font-size: 0.9rem;
            color: #888;
            margin-top: 4px;
        }

        .quiz-feedback {
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
        }

        .quiz-feedback.show {
            display: block;
        }

        .quiz-feedback.correct {
            background: rgba(46, 213, 115, 0.1);
            border: 2px solid #2ed573;
        }

        .quiz-feedback.wrong {
            background: rgba(255, 71, 87, 0.1);
            border: 2px solid #ff4757;
        }

        .quiz-feedback h4 {
            font-size: 1.1rem;
            margin-bottom: 8px;
        }

        .quiz-feedback.correct h4 {
            color: #2ed573;
        }

        .quiz-feedback.wrong h4 {
            color: #ff4757;
        }

        .quiz-feedback p {
            color: #c0b090;
        }

        /* Stats */
        .listen-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .stat-item {
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .stat-item.correct {
            background: rgba(46, 213, 115, 0.2);
            border: 2px solid #2ed573;
            color: #2ed573;
        }

        .stat-item.wrong {
            background: rgba(255, 71, 87, 0.2);
            border: 2px solid #ff4757;
            color: #ff4757;
        }

        .stat-item.total {
            background: rgba(136, 192, 208, 0.2);
            border: 2px solid #88c0d0;
            color: #88c0d0;
        }

        /* Quiz Complete */
        .quiz-complete {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .quiz-complete.active {
            display: block;
        }

        .quiz-complete h2 {
            font-size: 2rem;
            color: var(--text-hanzi);
            margin-bottom: 20px;
        }

        .complete-stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 30px;
        }

        .complete-stat {
            text-align: center;
        }

        .complete-stat-value {
            font-size: 2.5rem;
            font-weight: bold;
        }

        .complete-stat-value.correct {
            color: #2ed573;
        }

        .complete-stat-value.wrong {
            color: #ff4757;
        }

        .complete-stat-label {
            color: #888;
            font-size: 0.9rem;
        }

        .quiz-complete p {
            color: #a0a0a0;
            margin-bottom: 30px;
        }

        /* Footer */
        .listening-footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(136, 192, 208, 0.2);
            color: #666;
        }

        .listening-footer strong {
            color: #88c0d0;
        }
    </style>
</head>

<body>
    <!-- Theme Toggle -->
    <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">‚òÄÔ∏è</button>

    <div class="listening-container">
        <!-- Back Button -->
        <a href="index.html" class="back-btn">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>

        <!-- Header -->
        <header class="listening-header">
            <h1>üéß Listening Âê¨ÂäõÁªÉ‰π†</h1>
            <p>‡∏ù‡∏∂‡∏Å‡∏ü‡∏±‡∏á‡∏†‡∏≤‡∏©‡∏≤‡∏à‡∏µ‡∏ô‡∏à‡∏≤‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏û‡∏π‡∏î ‡πÅ‡∏•‡∏∞‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à</p>
        </header>

        <!-- Mode Selection -->
        <div class="mode-selection">
            <button class="mode-btn active" id="listenModeBtn">üéµ ‡∏ü‡∏±‡∏á‡πÅ‡∏•‡∏∞‡∏ï‡∏≠‡∏ö</button>
            <button class="mode-btn" id="quizModeBtn">üìù ‡∏ù‡∏∂‡∏Å‡∏´‡∏π</button>
        </div>

        <!-- Listen & Learn Mode -->
        <div class="listen-content active" id="listenContent">
            <div class="listen-card">
                <div class="listen-current-info">
                    <div class="listen-hanzi" id="listenHanzi">Âç¥</div>
                    <div class="listen-pinyin" id="listenPinyin">qu√®</div>
                    <div class="listen-type" id="listenType">‡∏Ñ‡∏≥‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°</div>
                    <div class="listen-meaning" id="listenMeaning">‡πÅ‡∏ï‡πà, ‡∏Å‡∏•‡∏±‡∏ö, ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÑ‡∏£‡∏Å‡πá‡∏ï‡∏≤‡∏°</div>
                </div>

                <div class="listen-play-section">
                    <button class="listen-main-btn" id="mainPlayBtn">üîä</button>

                    <div class="listen-speed-control">
                        <span class="listen-speed-label">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß:</span>
                        <button class="speed-btn" data-speed="0.5">0.5x</button>
                        <button class="speed-btn active" data-speed="0.8">0.8x</button>
                        <button class="speed-btn" data-speed="1">1x</button>
                    </div>
                </div>

                <div class="listen-auto-section">
                    <button class="auto-btn" id="autoPlayBtn">‚ñ∂Ô∏è ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</button>
                    <button class="auto-btn stop" id="stopAutoBtn" style="display: none;">‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î</button>
                </div>

                <div class="sentences-section">
                    <h3 class="sentences-title">üí¨ ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ</h3>
                    <div id="sentencesList">
                        <!-- Sentences will be generated dynamically -->
                    </div>
                </div>
            </div>

            <div class="listen-nav">
                <button class="nav-btn" id="prevBtn">‚¨ÖÔ∏è ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
                <button class="nav-btn primary" id="nextBtn">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚û°Ô∏è</button>
            </div>

            <div class="listen-progress">
                <span id="currentIndex">1</span> / <span id="totalItems">0</span>
            </div>
        </div>

        <!-- Quiz Mode (‡∏ù‡∏∂‡∏Å‡∏´‡∏π) -->
        <div class="listen-content" id="quizContent">
            <!-- Quiz Sub-mode Selection -->
            <div class="quiz-submode-selection">
                <button class="quiz-submode-btn active" id="wordQuizBtn">üî§ ‡∏ü‡∏±‡∏á‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</button>
                <button class="quiz-submode-btn" id="sentenceQuizBtn">üí¨ ‡∏ü‡∏±‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ</button>
            </div>

            <div class="listen-stats" id="quizStats">
                <span class="stat-item correct">‚úì ‡∏ñ‡∏π‡∏Å: <span id="correctCount">0</span></span>
                <span class="stat-item wrong">‚úó ‡∏ú‡∏¥‡∏î: <span id="wrongCount">0</span></span>
                <span class="stat-item total">üìö ‡∏Ç‡πâ‡∏≠: <span id="questionNum">1</span>/<span
                        id="totalQuestions">10</span></span>
            </div>

            <div class="quiz-card" id="quizCard">
                <p class="quiz-prompt" id="quizPrompt">‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:</p>

                <button class="quiz-play-btn" id="quizPlayBtn">üîä</button>

                <div class="quiz-options" id="quizOptions">
                    <!-- Options will be generated dynamically -->
                </div>

                <div class="quiz-feedback" id="quizFeedback">
                    <h4 id="feedbackTitle">‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!</h4>
                    <p id="feedbackText"></p>
                </div>

                <div class="listen-nav">
                    <button class="nav-btn primary" id="nextQuestionBtn" style="display: none;">‡∏Ç‡πâ‡∏≠‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚û°Ô∏è</button>
                </div>
            </div>

            <div class="quiz-complete" id="quizComplete">
                <h2>üéâ ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß!</h2>
                <div class="complete-stats">
                    <div class="complete-stat">
                        <div class="complete-stat-value correct" id="finalCorrect">0</div>
                        <div class="complete-stat-label">‡∏ï‡∏≠‡∏ö‡∏ñ‡∏π‡∏Å</div>
                    </div>
                    <div class="complete-stat">
                        <div class="complete-stat-value wrong" id="finalWrong">0</div>
                        <div class="complete-stat-label">‡∏ï‡∏≠‡∏ö‡∏ú‡∏¥‡∏î</div>
                    </div>
                </div>
                <p id="quizMessage">‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏°‡∏≤‡∏Å!</p>
                <button class="nav-btn primary" id="restartBtn">üîÑ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡πÉ‡∏´‡∏°‡πà</button>
            </div>
        </div>

        <!-- Footer -->
        <footer class="listening-footer">
            <p>Made with ‚ù§Ô∏è by <strong>PRNXT</strong></p>
        </footer>
    </div>

    <script src="grammar.js"></script>
    <script>
        // Variables
        let grammarPoints = [];
        let currentIndex = 0;
        let currentMode = 'listen'; // 'listen' or 'quiz'
        let quizSubMode = 'word'; // 'word' or 'sentence'
        let speechRate = 0.8;
        let isAutoPlaying = false;
        let autoPlayTimeout = null;

        // Quiz variables
        let quizQuestions = [];
        let currentQuizIndex = 0;
        let correctAnswers = 0;
        let wrongAnswers = 0;

        // DOM Elements
        const listenModeBtn = document.getElementById('listenModeBtn');
        const quizModeBtn = document.getElementById('quizModeBtn');
        const listenContent = document.getElementById('listenContent');
        const quizContent = document.getElementById('quizContent');

        // Load data
        async function loadData() {
            try {
                if (typeof grammarData !== 'undefined' && grammarData !== null) {
                    grammarPoints = grammarData;
                } else {
                    const response = await fetch('cn_grammar.json');
                    const data = await response.json();
                    grammarPoints = data.grammar_points || [];
                }

                document.getElementById('totalItems').textContent = grammarPoints.length;

                if (grammarPoints.length > 0) {
                    displayListenItem(0);
                }
            } catch (error) {
                console.error('Error loading data:', error);
                if (typeof grammarData !== 'undefined' && grammarData !== null) {
                    grammarPoints = grammarData;
                    document.getElementById('totalItems').textContent = grammarPoints.length;
                    if (grammarPoints.length > 0) {
                        displayListenItem(0);
                    }
                }
            }
        }

        // Mode switching
        function switchMode(mode) {
            currentMode = mode;

            listenModeBtn.classList.toggle('active', mode === 'listen');
            quizModeBtn.classList.toggle('active', mode === 'quiz');

            listenContent.classList.toggle('active', mode === 'listen');
            quizContent.classList.toggle('active', mode === 'quiz');

            stopAutoPlay();

            if (mode === 'quiz') {
                startQuiz();
            }
        }

        listenModeBtn.addEventListener('click', () => switchMode('listen'));
        quizModeBtn.addEventListener('click', () => switchMode('quiz'));

        // Display listen item
        function displayListenItem(index) {
            if (index < 0 || index >= grammarPoints.length) return;

            currentIndex = index;
            const item = grammarPoints[index];

            document.getElementById('listenHanzi').textContent = item.hanzi;
            document.getElementById('listenPinyin').textContent = item.pinyin;
            document.getElementById('listenType').textContent = item.type;

            const meanings = Array.isArray(item.meaning_th)
                ? item.meaning_th.join(', ')
                : item.meaning_th;
            document.getElementById('listenMeaning').textContent = meanings;

            // Display sentences
            const sentencesList = document.getElementById('sentencesList');
            sentencesList.innerHTML = item.examples.map((ex, idx) => `
                <div class="sentence-item" data-index="${idx}">
                    <button class="sentence-play-btn" data-text="${ex.zh}">üîä</button>
                    <div class="sentence-content">
                        <div class="sentence-zh">${ex.zh}</div>
                        <div class="sentence-th">${ex.th}</div>
                    </div>
                </div>
            `).join('');

            // Add event listeners to sentence play buttons
            document.querySelectorAll('.sentence-play-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const text = btn.dataset.text;
                    speakChinese(text, btn);
                });
            });

            // Update progress
            document.getElementById('currentIndex').textContent = index + 1;

            // Update nav buttons
            document.getElementById('prevBtn').disabled = index === 0;
            document.getElementById('nextBtn').disabled = index === grammarPoints.length - 1;
        }

        // Text to Speech
        function speakChinese(text, btnElement = null) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-CN';
                utterance.rate = speechRate;

                if (btnElement) {
                    btnElement.classList.add('playing');
                    utterance.onend = () => {
                        btnElement.classList.remove('playing');
                    };
                }

                window.speechSynthesis.speak(utterance);
            }
        }

        // Main play button
        document.getElementById('mainPlayBtn').addEventListener('click', () => {
            const hanzi = document.getElementById('listenHanzi').textContent;
            speakChinese(hanzi, document.getElementById('mainPlayBtn'));
        });

        // Speed control
        document.querySelectorAll('.speed-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                speechRate = parseFloat(btn.dataset.speed);
            });
        });

        // Auto play
        document.getElementById('autoPlayBtn').addEventListener('click', startAutoPlay);
        document.getElementById('stopAutoBtn').addEventListener('click', stopAutoPlay);

        function startAutoPlay() {
            isAutoPlaying = true;
            document.getElementById('autoPlayBtn').style.display = 'none';
            document.getElementById('stopAutoBtn').style.display = 'flex';

            playCurrentItemAuto();
        }

        function stopAutoPlay() {
            isAutoPlaying = false;
            document.getElementById('autoPlayBtn').style.display = 'flex';
            document.getElementById('stopAutoBtn').style.display = 'none';

            if (autoPlayTimeout) {
                clearTimeout(autoPlayTimeout);
                autoPlayTimeout = null;
            }
            window.speechSynthesis.cancel();
        }

        function playCurrentItemAuto() {
            if (!isAutoPlaying) return;

            const item = grammarPoints[currentIndex];

            // Play main word
            speakChinese(item.hanzi);

            // Play examples after delay
            let delay = 2000;
            item.examples.forEach((ex, idx) => {
                autoPlayTimeout = setTimeout(() => {
                    if (!isAutoPlaying) return;

                    // Highlight current sentence
                    document.querySelectorAll('.sentence-item').forEach(s => s.classList.remove('playing'));
                    const sentenceItem = document.querySelector(`.sentence-item[data-index="${idx}"]`);
                    if (sentenceItem) sentenceItem.classList.add('playing');

                    speakChinese(ex.zh);
                }, delay);
                delay += 3500;
            });

            // Move to next item
            autoPlayTimeout = setTimeout(() => {
                if (!isAutoPlaying) return;

                document.querySelectorAll('.sentence-item').forEach(s => s.classList.remove('playing'));

                if (currentIndex < grammarPoints.length - 1) {
                    displayListenItem(currentIndex + 1);
                    playCurrentItemAuto();
                } else {
                    stopAutoPlay();
                }
            }, delay + 1000);
        }

        // Navigation
        document.getElementById('prevBtn').addEventListener('click', () => {
            if (currentIndex > 0) {
                stopAutoPlay();
                displayListenItem(currentIndex - 1);
            }
        });

        document.getElementById('nextBtn').addEventListener('click', () => {
            if (currentIndex < grammarPoints.length - 1) {
                stopAutoPlay();
                displayListenItem(currentIndex + 1);
            }
        });

        // ==================== QUIZ MODE ====================

        function startQuiz() {
            correctAnswers = 0;
            wrongAnswers = 0;
            currentQuizIndex = 0;

            quizQuestions = generateQuizQuestions();

            document.getElementById('totalQuestions').textContent = quizQuestions.length;
            document.getElementById('correctCount').textContent = 0;
            document.getElementById('wrongCount').textContent = 0;

            document.getElementById('quizCard').style.display = 'block';
            document.getElementById('quizComplete').classList.remove('active');
            document.getElementById('quizStats').style.display = 'flex';

            displayQuizQuestion(0);
        }

        function generateQuizQuestions() {
            const questions = [];
            const shuffled = [...grammarPoints].sort(() => Math.random() - 0.5);
            const selected = shuffled.slice(0, Math.min(10, shuffled.length));

            if (quizSubMode === 'word') {
                // Word mode: Listen and choose correct hanzi (no pinyin shown)
                selected.forEach(item => {
                    // Type 1: Listen to word, choose correct hanzi
                    const wrongOptions = grammarPoints
                        .filter(g => g.hanzi !== item.hanzi)
                        .sort(() => Math.random() - 0.5)
                        .slice(0, 3);

                    questions.push({
                        type: 'hanzi',
                        questionText: 'üéß ‡∏ü‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á:',
                        audioText: item.hanzi,
                        answer: item.hanzi,
                        answerData: item,
                        options: [item, ...wrongOptions].sort(() => Math.random() - 0.5).map(opt => ({
                            display: opt.hanzi,
                            value: opt.hanzi
                        }))
                    });
                });
            } else {
                // Sentence mode: Listen to sentence, choose correct meaning
                selected.forEach(item => {
                    if (item.examples && item.examples.length > 0) {
                        const example = item.examples[Math.floor(Math.random() * item.examples.length)];

                        const wrongMeanings = grammarPoints
                            .filter(g => g.hanzi !== item.hanzi && g.examples && g.examples.length > 0)
                            .sort(() => Math.random() - 0.5)
                            .slice(0, 3)
                            .map(g => g.examples[0].th);

                        questions.push({
                            type: 'sentence',
                            questionText: 'üí¨ ‡∏ü‡∏±‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢:',
                            audioText: example.zh,
                            answer: example.th,
                            answerData: item,
                            originalSentence: example.zh,
                            options: [...wrongMeanings, example.th].sort(() => Math.random() - 0.5).map(opt => ({
                                display: opt,
                                value: opt
                            }))
                        });
                    }
                });
            }

            return questions;
        }

        function displayQuizQuestion(index) {
            if (index >= quizQuestions.length) {
                showQuizComplete();
                return;
            }

            const question = quizQuestions[index];
            currentQuizIndex = index;

            document.getElementById('questionNum').textContent = index + 1;
            document.getElementById('quizPrompt').textContent = question.questionText;

            // Generate options based on type
            let optionsHtml;
            if (question.type === 'sentence') {
                optionsHtml = question.options.map(opt => `
                    <button class="quiz-option quiz-option-thai" data-value="${opt.value}">
                        ${opt.display}
                    </button>
                `).join('');
            } else {
                // Word mode - no pinyin shown (HSK3 style)
                optionsHtml = question.options.map(opt => `
                    <button class="quiz-option" data-value="${opt.value}">
                        ${opt.display}
                    </button>
                `).join('');
            }
            document.getElementById('quizOptions').innerHTML = optionsHtml;

            // Add click events
            document.querySelectorAll('.quiz-option').forEach(btn => {
                btn.addEventListener('click', () => handleQuizAnswer(btn, question));
            });

            // Hide feedback and next button
            document.getElementById('quizFeedback').classList.remove('show', 'correct', 'wrong');
            document.getElementById('nextQuestionBtn').style.display = 'none';
        }

        // Quiz play button
        document.getElementById('quizPlayBtn').addEventListener('click', () => {
            const question = quizQuestions[currentQuizIndex];
            speakChinese(question.audioText, document.getElementById('quizPlayBtn'));
        });

        function handleQuizAnswer(selectedBtn, question) {
            const selected = selectedBtn.dataset.value;
            const isCorrect = selected === question.answer;

            // Disable all options
            document.querySelectorAll('.quiz-option').forEach(btn => {
                btn.classList.add('disabled');
                if (btn.dataset.value === question.answer) {
                    btn.classList.add('correct');
                } else if (btn === selectedBtn && !isCorrect) {
                    btn.classList.add('wrong');
                }
            });

            // Update stats
            if (isCorrect) {
                correctAnswers++;
                document.getElementById('correctCount').textContent = correctAnswers;
            } else {
                wrongAnswers++;
                document.getElementById('wrongCount').textContent = wrongAnswers;
            }

            // Show feedback based on question type
            const feedback = document.getElementById('quizFeedback');
            feedback.classList.add('show', isCorrect ? 'correct' : 'wrong');
            document.getElementById('feedbackTitle').textContent = isCorrect ? '‚úÖ ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!' : '‚ùå ‡∏ú‡∏¥‡∏î!';

            let feedbackContent = '';
            const item = question.answerData;
            const meanings = Array.isArray(item.meaning_th)
                ? item.meaning_th.join(', ')
                : item.meaning_th;

            if (question.type === 'hanzi') {
                feedbackContent = `<strong>${item.hanzi}</strong> (${item.pinyin})<br>${meanings}`;
            } else if (question.type === 'sentence') {
                feedbackContent = `<strong>${question.originalSentence}</strong><br>‡πÅ‡∏õ‡∏•‡∏ß‡πà‡∏≤: ${question.answer}`;
            } else if (question.type === 'pinyin') {
                feedbackContent = `<strong>${item.hanzi}</strong> ‡∏≠‡πà‡∏≤‡∏ô‡∏ß‡πà‡∏≤ <strong>${item.pinyin}</strong><br>${meanings}`;
            }

            document.getElementById('feedbackText').innerHTML = feedbackContent;

            document.getElementById('nextQuestionBtn').style.display = 'inline-flex';
        }

        document.getElementById('nextQuestionBtn').addEventListener('click', () => {
            displayQuizQuestion(currentQuizIndex + 1);
        });

        function showQuizComplete() {
            document.getElementById('quizCard').style.display = 'none';
            document.getElementById('quizComplete').classList.add('active');
            document.getElementById('finalCorrect').textContent = correctAnswers;
            document.getElementById('finalWrong').textContent = wrongAnswers;

            const percentage = (correctAnswers / quizQuestions.length) * 100;
            let message = '';
            if (percentage >= 90) message = 'üåü ‡∏¢‡∏≠‡∏î‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏°‡∏≤‡∏Å! ‡∏´‡∏π‡∏Ñ‡∏∏‡∏ì‡∏î‡∏µ‡∏°‡∏≤‡∏Å!';
            else if (percentage >= 70) message = 'üëè ‡∏ó‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ! ‡∏ù‡∏∂‡∏Å‡∏ü‡∏±‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡∏ô‡∏∞';
            else if (percentage >= 50) message = 'üí™ ‡∏û‡∏≠‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ! ‡∏•‡∏≠‡∏á‡∏ü‡∏±‡∏á‡∏ã‡πâ‡∏≥‡∏ö‡πà‡∏≠‡∏¢‡πÜ';
            else message = 'üìö ‡∏•‡∏≠‡∏á‡∏ù‡∏∂‡∏Å‡∏ü‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';

            document.getElementById('quizMessage').textContent = message;
        }

        document.getElementById('restartBtn').addEventListener('click', startQuiz);

        // Quiz sub-mode buttons
        document.getElementById('wordQuizBtn').addEventListener('click', () => {
            quizSubMode = 'word';
            document.getElementById('wordQuizBtn').classList.add('active');
            document.getElementById('sentenceQuizBtn').classList.remove('active');
            startQuiz();
        });

        document.getElementById('sentenceQuizBtn').addEventListener('click', () => {
            quizSubMode = 'sentence';
            document.getElementById('sentenceQuizBtn').classList.add('active');
            document.getElementById('wordQuizBtn').classList.remove('active');
            startQuiz();
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (currentMode === 'listen') {
                if (e.key === 'ArrowLeft') {
                    document.getElementById('prevBtn').click();
                } else if (e.key === 'ArrowRight') {
                    document.getElementById('nextBtn').click();
                } else if (e.key === ' ') {
                    e.preventDefault();
                    document.getElementById('mainPlayBtn').click();
                }
            }
        });

        // Initialize
        loadData();
    </script>
</body>

</html>